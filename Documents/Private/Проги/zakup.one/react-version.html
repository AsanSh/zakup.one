<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zakup.one - React –≤–µ—Ä—Å–∏—è —Å LiveSearch</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="demo-data.js"></script>
    <script src="api.js"></script>
    <link rel="stylesheet" href="react-styles.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // LiveSearch Component
        function LiveSearch() {
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [cart, setCart] = useState([]);
            const [category, setCategory] = useState("all");
            const [showCheckout, setShowCheckout] = useState(false);
            const [customer, setCustomer] = useState({ 
                name: "", 
                phone: "", 
                address: "" 
            });

            const categories = ["–í—Å–µ", "–ê—Ä–º–∞—Ç—É—Ä–∞", "–î–≤—É—Ç–∞–≤—Ä—ã", "–®–≤–µ–ª–ª–µ—Ä—ã", "–£–≥–æ–ª–∫–∏", "–õ–∏—Å—Ç—ã", "–¢—Ä—É–±—ã", "–ü—Ä–æ–≤–æ–ª–æ–∫–∞", "–°–µ—Ç–∫–∏", "–ö—Ä–µ–ø–µ–∂", "–ü—Ä–æ—á–µ–µ"];

            // –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤
            useEffect(() => {
                const timeout = setTimeout(async () => {
                    if (query.trim().length > 0 || category !== "all") {
                        try {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π API –∏–ª–∏ fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π
                            const apiUrl = 'http://localhost:3000/api/products';
                            const params = new URLSearchParams({
                                search: query,
                                category: category === "all" ? "" : category
                            });
                            
                            try {
                                const response = await axios.get(`${apiUrl}?${params}`);
                                setResults(response.data);
                            } catch (apiError) {
                                console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                                // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π API
                                const results = await window.ProductAPI.searchProductsAsync(query, category);
                                setResults(results);
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                            setResults([]);
                        }
                    } else {
                        setResults([]);
                    }
                }, 300);
                return () => clearTimeout(timeout);
            }, [query, category]);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
            const toggleCart = (item) => {
                setCart((prev) =>
                    prev.some((p) => p.id === item.id)
                        ? prev.filter((p) => p.id !== item.id)
                        : [...prev, item]
                );
            };

            // –ü–æ–¥—Å—á—ë—Ç —Å—É–º–º—ã –∫–æ—Ä–∑–∏–Ω—ã
            const total = cart.reduce((sum, item) => sum + item.price, 0);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–∞
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!customer.name || !customer.phone || !customer.address) {
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
                    return;
                }
                
                const order = { 
                    customer, 
                    items: cart, 
                    total,
                    orderNumber: `#${Date.now()}`,
                    date: new Date().toLocaleDateString('ru-RU')
                };
                
                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    const apiUrl = 'http://localhost:3000/api/orders';
                    try {
                        const response = await axios.post(apiUrl, order);
                        console.log("üì¶ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω:", response.data);
                        
                        // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.showAlert("‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ!");
                        } else {
                            alert("‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ!");
                        }
                    } catch (apiError) {
                        console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
                        console.log("üì¶ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ (–ª–æ–∫–∞–ª—å–Ω–æ):", order);
                        
                        // Fallback - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        const existingOrders = JSON.parse(localStorage.getItem('zakup-orders') || '[]');
                        existingOrders.push(order);
                        localStorage.setItem('zakup-orders', JSON.stringify(existingOrders));
                        
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.showAlert("‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ!");
                        } else {
                            alert("‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ!");
                        }
                    }
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    setCart([]);
                    setCustomer({ name: "", phone: "", address: "" });
                    setShowCheckout(false);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:', error);
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
                }
            };

            return (
                <div className="livesearch-container">
                    {/* –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ */}
                    <div className="search-panel">
                        <div className="search-input-container">
                            <input
                                type="text"
                                placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..."
                                value={query}
                                onChange={(e) => setQuery(e.target.value)}
                                className="search-input"
                            />
                        </div>
                        <div className="category-select-container">
                            <select
                                value={category}
                                onChange={(e) => setCategory(e.target.value)}
                                className="category-select"
                            >
                                {categories.map((c, i) => (
                                    <option key={i} value={c === "–í—Å–µ" ? "all" : c}>
                                        {c}
                                    </option>
                                ))}
                            </select>
                        </div>
                    </div>

                    {/* –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */}
                    {results.length > 0 && (
                        <div className="results-table-container">
                            <table className="results-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–ï–¥. –∏–∑–º.</th>
                                        <th>–¶–µ–Ω–∞</th>
                                        <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {results.map((item) => (
                                        <tr key={item.id}>
                                            <td className="checkbox-cell">
                                                <input
                                                    type="checkbox"
                                                    checked={cart.some((c) => c.id === item.id)}
                                                    onChange={() => toggleCart(item)}
                                                />
                                            </td>
                                            <td className="product-name">{item.name}</td>
                                            <td className="product-unit">{item.unit}</td>
                                            <td className="product-price">{item.price} —Å–æ–º</td>
                                            <td className="product-supplier">{item.supplier}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {/* –ö–æ—Ä–∑–∏–Ω–∞ */}
                    {cart.length > 0 && !showCheckout && (
                        <div className="cart-container">
                            <h3 className="cart-title">üõí –ö–æ—Ä–∑–∏–Ω–∞ ({cart.length})</h3>
                            <div className="cart-items">
                                {cart.map((item) => (
                                    <div key={item.id} className="cart-item">
                                        <span className="cart-item-name">{item.name}</span>
                                        <span className="cart-item-price">{item.price} —Å–æ–º</span>
                                    </div>
                                ))}
                            </div>
                            <div className="cart-total">
                                <span>–ò—Ç–æ–≥–æ:</span>
                                <span>{total.toLocaleString()} —Å–æ–º</span>
                            </div>
                            <button
                                onClick={() => setShowCheckout(true)}
                                className="checkout-btn"
                            >
                                –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        </div>
                    )}

                    {/* –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ */}
                    {showCheckout && (
                        <form onSubmit={handleSubmit} className="checkout-form">
                            <h3 className="checkout-title">üì¶ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>

                            <div className="form-group">
                                <input
                                    type="text"
                                    placeholder="–ò–º—è"
                                    value={customer.name}
                                    onChange={(e) => setCustomer({ ...customer, name: e.target.value })}
                                    className="form-input"
                                />
                            </div>

                            <div className="form-group">
                                <input
                                    type="tel"
                                    placeholder="–¢–µ–ª–µ—Ñ–æ–Ω"
                                    value={customer.phone}
                                    onChange={(e) => setCustomer({ ...customer, phone: e.target.value })}
                                    className="form-input"
                                />
                            </div>

                            <div className="form-group">
                                <textarea
                                    placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"
                                    value={customer.address}
                                    onChange={(e) => setCustomer({ ...customer, address: e.target.value })}
                                    className="form-textarea"
                                />
                            </div>

                            <div className="order-total">
                                <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                                <span>{total.toLocaleString()} —Å–æ–º</span>
                            </div>

                            <div className="form-actions">
                                <button
                                    type="button"
                                    onClick={() => setShowCheckout(false)}
                                    className="btn-secondary"
                                >
                                    –ù–∞–∑–∞–¥
                                </button>
                                <button
                                    type="submit"
                                    className="btn-primary"
                                >
                                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
                                </button>
                            </div>
                        </form>
                    )}
                </div>
            );
        }

        // Header Component
        function Header() {
            return (
                <header className="app-header">
                    <div className="header-content">
                        <div className="app-title">
                            <h1>zakup.one</h1>
                            <p>LiveSearch - –ü–æ–∏—Å–∫ –∏ –∑–∞–∫–∞–∑ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
                        </div>
                        <div className="header-actions">
                            <button className="version-switcher" onClick={() => window.location.href = '/'}>
                                <svg className="icon-svg" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                <span>–ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</span>
                            </button>
                        </div>
                    </div>
                </header>
            );
        }

        // Main App Component
        function App() {
            return (
                <div className="app">
                    <Header />
                    <main className="main-content">
                        <LiveSearch />
                    </main>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
